import{_ as e,r as o,o as l,c as p,d as n,e as a,a as t,b as i}from"./app-B6NiJo-f.js";const r={},c=i(`<h1 id="基于aws-lambda函数实现cloudfront-github-oauth" tabindex="-1"><a class="header-anchor" href="#基于aws-lambda函数实现cloudfront-github-oauth"><span>基于AWS Lambda函数实现CloudFront GitHub OAuth</span></a></h1><h2 id="业务场景" tabindex="-1"><a class="header-anchor" href="#业务场景"><span>业务场景</span></a></h2><p>AWS S3可用于静态网页托管，但由于部分网页存在敏感信息，游客不能够直接访问网页，则需要对用户鉴权，于是通过 CloudFront 对S3资源进行访问，并使用Lambda函数处理 GitHub OAuth 接口，实现对用户请求进行拦截并鉴权。</p><h2 id="配置流程" tabindex="-1"><a class="header-anchor" href="#配置流程"><span>配置流程</span></a></h2><h3 id="s3-bucket配置" tabindex="-1"><a class="header-anchor" href="#s3-bucket配置"><span>S3 Bucket配置</span></a></h3><p>由于该Bucket的存储敏感信息，不应通过HTTP直接访问到S3文件，存储桶策略应配置只允许 CloudFront 访问对应目录下文件。（也可以在创建CloudFront时勾选相关配置，自动配置该Bucket的权限）</p><p>配置策略参考：</p><div class="language-json line-numbers-mode" data-ext="json" data-title="json"><pre class="language-json"><code><span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token property">&quot;Version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2008-10-17&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;Id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;PolicyForCloudFrontPrivateContent&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;Statement&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">        <span class="token punctuation">{</span></span>
<span class="line">            <span class="token property">&quot;Sid&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token property">&quot;Effect&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Allow&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token property">&quot;Principal&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token property">&quot;AWS&quot;</span><span class="token operator">:</span> <span class="token string">&quot;arn:aws:iam::cloudfront:user/CloudFront Origin Access Identity E1US02RSZVS2VI&quot;</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token property">&quot;Action&quot;</span><span class="token operator">:</span> <span class="token string">&quot;s3:GetObject&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token property">&quot;Resource&quot;</span><span class="token operator">:</span> <span class="token string">&quot;arn:aws:s3:::github-actions-runner-artifact/*&quot;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="cloudfront配置" tabindex="-1"><a class="header-anchor" href="#cloudfront配置"><span>CloudFront配置</span></a></h3><p>CloudFront 源选择创建好的 S3 Bucket，访问策略选择只访问 CLoudFront，参考上文存储桶策略或按图中配置方式进行创建</p><p><img src="https://s2.loli.net/2022/06/06/6mAzPYqoHUtneiK.png" alt="bd772caf-8ae6-45cf-a96b-e9316d0efc65.png"></p><p>行为配置需要拦截http请求，并使用Lambda函数，配置方式参考：</p><p><img src="https://s2.loli.net/2022/06/06/CDKQIZu3MpLa6YU.png" alt="4eca93e8-c244-4a7b-a36b-355657c326c1.png"></p><h3 id="lambda函数配置" tabindex="-1"><a class="header-anchor" href="#lambda函数配置"><span>Lambda函数配置</span></a></h3>`,14),u={href:"https://github.com/Widen/cloudfront-auth/wiki/Manual-Deployment",target:"_blank",rel:"noopener noreferrer"},d=n("p",null,[n("img",{src:"https://s2.loli.net/2022/06/06/SU8sYZ7G1yPNwqA.png",alt:"c3433fe3-ace8-41bf-ac39-4e36bd15a661.png"})],-1),h=n("h3",{id:"创建github-oauth-app",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#创建github-oauth-app"},[n("span",null,"创建GitHub OAuth App")])],-1),b={href:"https://docs.github.com/en/developers/apps/building-oauth-apps/creating-an-oauth-app",target:"_blank",rel:"noopener noreferrer"},k=n("code",null,"${CloudFront_URL}/_calback",-1),m={href:"https://github.com/Widen/cloudfront-auth",target:"_blank",rel:"noopener noreferrer"},g={href:"https://docs.github.com/en/rest/reference/orgs#list-organizations-for-the-authenticated-user",target:"_blank",rel:"noopener noreferrer"},f=n("p",null,[a("重新打包后上传并发布版本，将 "),n("code",null,"ARN:version"),a(" 填写到 CloudFront 行为的函数关联。访问 CloudFront 进行测试。")],-1),v=n("h2",{id:"参考链接",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#参考链接"},[n("span",null,"参考链接")])],-1),_={href:"https://docs.github.com/en/developers/apps/building-oauth-apps/authorizing-oauth-apps",target:"_blank",rel:"noopener noreferrer"},q={href:"https://github.com/Widen/cloudfront-auth",target:"_blank",rel:"noopener noreferrer"},A={href:"https://github.com/Widen/cloudfront-auth/wiki/Manual-Deployment",target:"_blank",rel:"noopener noreferrer"};function S(C,F){const s=o("ExternalLinkIcon");return l(),p("div",null,[c,n("p",null,[a("创建Lambda函数参考 "),n("a",u,[a("配置Wiki"),t(s)]),a(" 需要注意该函数的权限配置，选择策略模板为基本Lambda@Edge权限，参考：")]),d,h,n("p",null,[a("该步骤无特殊配置，参考"),n("a",b,[a("WiKi"),t(s)]),a("，HomePage URL填写为CloudFront URL，Callback URL为"),k,a("，最终生成 Client ID与Secrets。")]),n("p",null,[a("使用 "),n("a",m,[a("参考代码"),t(s)]),a(" 生成OAuth代码，解压并修改生成后的源码进行二次开发，实现根据Github组织鉴权，具体修改内容参考：")]),n("ul",null,[n("li",null,[n("a",g,[a("获取用户组织接口"),t(s)])])]),f,v,n("ul",null,[n("li",null,[n("a",_,[a("Github OAuth Wiki"),t(s)])]),n("li",null,[n("a",q,[a("Github 开源代码"),t(s)])]),n("li",null,[n("a",A,[a("配置 Wiki"),t(s)])])])])}const L=e(r,[["render",S],["__file","AWSCloudFrontwithOAuth.html.vue"]]),x=JSON.parse('{"path":"/blogs/backend/AWSCloudFrontwithOAuth.html","title":"基于AWS Lambda函数实现CloudFront GitHub OAuth","lang":"en-US","frontmatter":{"tags":["AWS","Github","OAuth"],"categories":["backend"],"date":"2022-04-20 16:15"},"headers":[{"level":2,"title":"业务场景","slug":"业务场景","link":"#业务场景","children":[]},{"level":2,"title":"配置流程","slug":"配置流程","link":"#配置流程","children":[{"level":3,"title":"S3 Bucket配置","slug":"s3-bucket配置","link":"#s3-bucket配置","children":[]},{"level":3,"title":"CloudFront配置","slug":"cloudfront配置","link":"#cloudfront配置","children":[]},{"level":3,"title":"Lambda函数配置","slug":"lambda函数配置","link":"#lambda函数配置","children":[]},{"level":3,"title":"创建GitHub OAuth App","slug":"创建github-oauth-app","link":"#创建github-oauth-app","children":[]}]},{"level":2,"title":"参考链接","slug":"参考链接","link":"#参考链接","children":[]}],"git":{"createdTime":1717432393000,"updatedTime":1717432393000,"contributors":[{"name":"Rain","email":"smalltime153@gmail.com","commits":1}]},"filePathRelative":"blogs/backend/AWSCloudFrontwithOAuth.md"}');export{L as comp,x as data};
