<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-rc.12">
    <script>
      (function() {
        const userMode = localStorage.getItem('vuepress-reco-color-scheme') || 'auto';
        const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;

        if (userMode === 'dark' || (userMode === 'auto' && systemDarkMode)) {
          document.documentElement.classList.toggle('dark', true);
        }
      })();
    </script>
    <title>限流组件实现 | Rain的心情杂货铺</title><meta name="description" content="You can't see the moon due to the rainy day.">
    <link rel="preload" href="/assets/style-DGbBJQtf.css" as="style"><link rel="stylesheet" href="/assets/style-DGbBJQtf.css">
    <link rel="modulepreload" href="/assets/app-B6NiJo-f.js"><link rel="modulepreload" href="/assets/rateLimiter.html-BIVD7gD-.js">
    <link rel="prefetch" href="/assets/timeline.html-DODvToYG.js" as="script"><link rel="prefetch" href="/assets/posts.html-BwWN-5BT.js" as="script"><link rel="prefetch" href="/assets/friendship-link.html-Cyt2Ol03.js" as="script"><link rel="prefetch" href="/assets/1.html-Bty4NFev.js" as="script"><link rel="prefetch" href="/assets/1.html-DVUjGiTU.js" as="script"><link rel="prefetch" href="/assets/1.html-Cr-Qf8Hd.js" as="script"><link rel="prefetch" href="/assets/1.html-DNXBR4B5.js" as="script"><link rel="prefetch" href="/assets/1.html-CHV3fxmv.js" as="script"><link rel="prefetch" href="/assets/2.html-DpwIBI7Q.js" as="script"><link rel="prefetch" href="/assets/1.html-DwOkYfIk.js" as="script"><link rel="prefetch" href="/assets/1.html-B6lpQUzf.js" as="script"><link rel="prefetch" href="/assets/1.html-D6JRaLX0.js" as="script"><link rel="prefetch" href="/assets/1.html-BEbdxwI-.js" as="script"><link rel="prefetch" href="/assets/1.html-vkU649sD.js" as="script"><link rel="prefetch" href="/assets/1.html-DK6yw-Tf.js" as="script"><link rel="prefetch" href="/assets/1.html-vsAwtqq2.js" as="script"><link rel="prefetch" href="/assets/1.html-D209XTtr.js" as="script"><link rel="prefetch" href="/assets/1.html-BRxIJtSa.js" as="script"><link rel="prefetch" href="/assets/1.html-Dyn9UOin.js" as="script"><link rel="prefetch" href="/assets/1.html-giPoxnmx.js" as="script"><link rel="prefetch" href="/assets/1.html-m1uv3Xlt.js" as="script"><link rel="prefetch" href="/assets/1.html-hhqUyVVA.js" as="script"><link rel="prefetch" href="/assets/1.html-qf89Ustq.js" as="script"><link rel="prefetch" href="/assets/1.html-COuGToAi.js" as="script"><link rel="prefetch" href="/assets/1.html-MrRy-GaI.js" as="script"><link rel="prefetch" href="/assets/1.html-fh6C8h9J.js" as="script"><link rel="prefetch" href="/assets/1.html-qp5R_SGt.js" as="script"><link rel="prefetch" href="/assets/1.html-XoK4IjC8.js" as="script"><link rel="prefetch" href="/assets/1.html-DVxd1yzm.js" as="script"><link rel="prefetch" href="/assets/1.html-BNqG0mDF.js" as="script"><link rel="prefetch" href="/assets/1.html-BLa-YmVn.js" as="script"><link rel="prefetch" href="/assets/1.html-DGms_xWP.js" as="script"><link rel="prefetch" href="/assets/1.html-Cqbk1m-6.js" as="script"><link rel="prefetch" href="/assets/1.html-OMBBxEcW.js" as="script"><link rel="prefetch" href="/assets/1.html-DTpTkbvv.js" as="script"><link rel="prefetch" href="/assets/1.html-B-02VdZK.js" as="script"><link rel="prefetch" href="/assets/1.html-djcvHRFJ.js" as="script"><link rel="prefetch" href="/assets/1.html-DB2Nrk74.js" as="script"><link rel="prefetch" href="/assets/1.html-j_pdIWtQ.js" as="script"><link rel="prefetch" href="/assets/1.html-TeBln39u.js" as="script"><link rel="prefetch" href="/assets/1.html-CEEFR-F5.js" as="script"><link rel="prefetch" href="/assets/1.html-Dy6uVeot.js" as="script"><link rel="prefetch" href="/assets/1.html-EWA7CtEz.js" as="script"><link rel="prefetch" href="/assets/1.html-BBCHTnph.js" as="script"><link rel="prefetch" href="/assets/2.html-Cc484O6D.js" as="script"><link rel="prefetch" href="/assets/3.html-DFBnTgai.js" as="script"><link rel="prefetch" href="/assets/4.html-CWfIGort.js" as="script"><link rel="prefetch" href="/assets/index.html-BmP8XGpo.js" as="script"><link rel="prefetch" href="/assets/20200417fib.html-gRgwO5s-.js" as="script"><link rel="prefetch" href="/assets/20210103removeDuplicates.html-CIDFeEH6.js" as="script"><link rel="prefetch" href="/assets/AWSCloudFrontwithOAuth.html-DwFNtRSt.js" as="script"><link rel="prefetch" href="/assets/GolangSync.html-BHt1Z43c.js" as="script"><link rel="prefetch" href="/assets/GolangTemplate.html-Cx6_Yat4.js" as="script"><link rel="prefetch" href="/assets/fabric.html-D0BlNnrp.js" as="script"><link rel="prefetch" href="/assets/20200414FontResume.html--UJgat1k.js" as="script"><link rel="prefetch" href="/assets/FontBasis.html-gw2ELfwJ.js" as="script"><link rel="prefetch" href="/assets/FontComprehensive.html-eQzhHx3Y.js" as="script"><link rel="prefetch" href="/assets/FontNetwork.html-De9TmSFH.js" as="script"><link rel="prefetch" href="/assets/InterviewLayout.html-D7tcvO_P.js" as="script"><link rel="prefetch" href="/assets/proxy.html-DymtsEEo.js" as="script"><link rel="prefetch" href="/assets/20190524LearnVue.html-BmwV4nGx.js" as="script"><link rel="prefetch" href="/assets/20201025LearnReact.html-CxnfDbV9.js" as="script"><link rel="prefetch" href="/assets/20210429rebase.html-Djl7YcKR.js" as="script"><link rel="prefetch" href="/assets/20210910KeyboardShortcut.html-BsTAbrGj.js" as="script"><link rel="prefetch" href="/assets/20181123Git.html-DgntDlku.js" as="script"><link rel="prefetch" href="/assets/20190130hexo.html-ny1kuV79.js" as="script"><link rel="prefetch" href="/assets/20190219Router1.html-Bc3CHscC.js" as="script"><link rel="prefetch" href="/assets/20190219Router2.html-V7_28C5d.js" as="script"><link rel="prefetch" href="/assets/20190526FixVMware.html-DTdx4RUg.js" as="script"><link rel="prefetch" href="/assets/20190817sql.html-B4L9PC81.js" as="script"><link rel="prefetch" href="/assets/20191119CentOS7Config.html-BC0rA2l5.js" as="script"><link rel="prefetch" href="/assets/20191119MongodbConfig.html-BQpsJb9Y.js" as="script"><link rel="prefetch" href="/assets/20201107ServerSSH.html-B62L17eE.js" as="script"><link rel="prefetch" href="/assets/20210210mysql8.html-DpaD13pd.js" as="script"><link rel="prefetch" href="/assets/20210210wsl_zsh.html-RZdVRMF9.js" as="script"><link rel="prefetch" href="/assets/20210301GithubMirror.html-DurQKeKk.js" as="script"><link rel="prefetch" href="/assets/20190731VueUpdateBUG.html-CwyeR9kM.js" as="script"><link rel="prefetch" href="/assets/20190828VueBuild.html-NM96szT5.js" as="script"><link rel="prefetch" href="/assets/20190926Project.html-Bm7t1ToL.js" as="script"><link rel="prefetch" href="/assets/20191125Vue-CLI4andVant.html-BJQ-6JYb.js" as="script"><link rel="prefetch" href="/assets/20200518Vueandthis.html-BIFw_ef0.js" as="script"><link rel="prefetch" href="/assets/20201217deepClone.html-CkZ5ETUy.js" as="script"><link rel="prefetch" href="/assets/20210318WebpackToVite.html-Bwpa2Mkx.js" as="script"><link rel="prefetch" href="/assets/404.html-OXAafjfs.js" as="script"><link rel="prefetch" href="/assets/reco-valine-BI2JzRng.js" as="script"><link rel="prefetch" href="/assets/giscus-aTimukGI-CKTvSCx2.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><div class="common-wrapper series--no show-catalog"><header class="navbar-container" style="top:0;"><div class="site-brand nav-item"><img class="logo" src="/logo.png" alt="Rain的心情杂货铺"><a href="/" class="site-name can-hide">Rain的心情杂货铺</a></div><div class="nav-item navbar-links-wrapper" style=""><div><form class="search-box" role="search"><input type="search" autocomplete="off" spellcheck="false" value><!----></form></div><nav class="navbar-links"><!--[--><div class="navbar-links__item"><a href="/" class="link" aria-label="首页"><!--[--><!--]--><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:inherit;"><path d="M16 4A12 12 0 1 1 4 16A12 12 0 0 1 16 4m0-2a14 14 0 1 0 14 14A14 14 0 0 0 16 2z" fill="currentColor"></path><path d="M23 10.41L21.59 9l-4.3 4.3a3 3 0 0 0-4 4L9 21.59L10.41 23l4.3-4.3a3 3 0 0 0 4-4zM17 16a1 1 0 1 1-1-1a1 1 0 0 1 1 1z" fill="currentColor"></path><circle cx="16" cy="7.5" r="1.5" fill="currentColor"></circle></svg><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->首页<!--]--></span></span><!--[--><!--]--></a></div><div class="navbar-links__item"><div class="dropdown-link"><button class="dropdown-link__title" type="button" aria-label="分类"><span class="xicon-container left title"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->分类<!--]--></span></span><span class="arrow down"></span></button><button class="dropdown-link--mobile__title" type="button" aria-label="分类"><span class="title"><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->分类<!--]--></span></span></span><span class="right arrow"></span></button><ul style="display:none;" class="dropdown-link__container"><!--[--><li class="dropdown-link__item"><a href="/categories/backend/1.html" class="link" aria-label="backend"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->backend<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/categories/note/1.html" class="link" aria-label="note"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->note<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/categories/network/1.html" class="link" aria-label="network"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->network<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/categories/web/1.html" class="link" aria-label="web"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->web<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/categories/technology/1.html" class="link" aria-label="technology"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->technology<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/categories/arithmetic/1.html" class="link" aria-label="arithmetic"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->arithmetic<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/categories/interview/1.html" class="link" aria-label="interview"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->interview<!--]--></span></span><!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-links__item"><div class="dropdown-link"><button class="dropdown-link__title" type="button" aria-label="标签"><span class="xicon-container left title"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->标签<!--]--></span></span><span class="arrow down"></span></button><button class="dropdown-link--mobile__title" type="button" aria-label="标签"><span class="title"><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->标签<!--]--></span></span></span><span class="right arrow"></span></button><ul style="display:none;" class="dropdown-link__container"><!--[--><li class="dropdown-link__item"><a href="/tags/Golang/1.html" class="link" aria-label="Golang"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->Golang<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/gaobingfa/1.html" class="link" aria-label="高并发"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->高并发<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/AWS/1.html" class="link" aria-label="AWS"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->AWS<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/Github/1.html" class="link" aria-label="Github"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->Github<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/OAuth/1.html" class="link" aria-label="OAuth"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->OAuth<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/xiaolv/1.html" class="link" aria-label="效率"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->效率<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/wangluo/1.html" class="link" aria-label="网络"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->网络<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/peizhi/1.html" class="link" aria-label="配置"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->配置<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/houduan/1.html" class="link" aria-label="后端"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->后端<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/qukuailian/1.html" class="link" aria-label="区块链"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->区块链<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/Git/1.html" class="link" aria-label="Git"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->Git<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/Vue/1.html" class="link" aria-label="Vue"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->Vue<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/Webpack/1.html" class="link" aria-label="Webpack"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->Webpack<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/Vite/1.html" class="link" aria-label="Vite"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->Vite<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/gongju/1.html" class="link" aria-label="工具"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->工具<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/Linux/1.html" class="link" aria-label="Linux"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->Linux<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/kaifahuanjing/1.html" class="link" aria-label="开发环境"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->开发环境<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/MySQL/1.html" class="link" aria-label="MySQL"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->MySQL<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/mianshi/1.html" class="link" aria-label="面试"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->面试<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/qianduan/1.html" class="link" aria-label="前端"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->前端<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/suanfa/1.html" class="link" aria-label="算法"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->算法<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/JavaScript/1.html" class="link" aria-label="JavaScript"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->JavaScript<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/CentOS/1.html" class="link" aria-label="CentOS"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->CentOS<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/React/1.html" class="link" aria-label="React"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->React<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/ES6/1.html" class="link" aria-label="ES6"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->ES6<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/zhuanzai/1.html" class="link" aria-label="转载"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->转载<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/baocuo/1.html" class="link" aria-label="报错"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->报错<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/PHP/1.html" class="link" aria-label="PHP"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->PHP<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/sql/1.html" class="link" aria-label="sql"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->sql<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/gaoji/1.html" class="link" aria-label="搞机"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->搞机<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/luyouqi/1.html" class="link" aria-label="路由器"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->路由器<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/hexo/1.html" class="link" aria-label="hexo"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->hexo<!--]--></span></span><!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-links__item"><a class="link" href="https://github.com/12ain/blog" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->GitHub<!--]--></span></span><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><span class="xicon-container btn-toggle-dark-mode btn--dark-mode"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" style="width:20px;height:20px;font-size:20px;color:inherit;"><path d="M15 2h2v3h-2z" fill="currentColor"></path><path d="M27 15h3v2h-3z" fill="currentColor"></path><path d="M15 27h2v3h-2z" fill="currentColor"></path><path d="M2 15h3v2H2z" fill="currentColor"></path><path d="M5.45 6.884l1.414-1.415l2.121 2.122l-1.414 1.414z" fill="currentColor"></path><path d="M23 7.58l2.121-2.12l1.414 1.414l-2.121 2.121z" fill="currentColor"></path><path d="M23.002 24.416l1.415-1.414l2.12 2.122l-1.413 1.414z" fill="currentColor"></path><path d="M5.47 25.13L7.59 23L9 24.42l-2.12 2.12l-1.41-1.41z" fill="currentColor"></path><path d="M16 8a8 8 0 1 0 8 8a8 8 0 0 0-8-8zm0 14a6 6 0 0 1 0-12z" fill="currentColor"></path></svg></span><span class="xicon-container btn-toggle-menus"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" style="width:20px;height:20px;font-size:20px;color:inherit;"><circle cx="16" cy="8" r="2" fill="currentColor"></circle><circle cx="16" cy="16" r="2" fill="currentColor"></circle><circle cx="16" cy="24" r="2" fill="currentColor"></circle></svg></span></div></header><!----><div class="mobile-menus-container"><nav class="navbar-links mobile"><!--[--><div class="navbar-links__item"><a href="/" class="link" aria-label="首页"><!--[--><!--]--><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:inherit;"><path d="M16 4A12 12 0 1 1 4 16A12 12 0 0 1 16 4m0-2a14 14 0 1 0 14 14A14 14 0 0 0 16 2z" fill="currentColor"></path><path d="M23 10.41L21.59 9l-4.3 4.3a3 3 0 0 0-4 4L9 21.59L10.41 23l4.3-4.3a3 3 0 0 0 4-4zM17 16a1 1 0 1 1-1-1a1 1 0 0 1 1 1z" fill="currentColor"></path><circle cx="16" cy="7.5" r="1.5" fill="currentColor"></circle></svg><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->首页<!--]--></span></span><!--[--><!--]--></a></div><div class="navbar-links__item"><div class="dropdown-link"><button class="dropdown-link__title" type="button" aria-label="分类"><span class="xicon-container left title"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->分类<!--]--></span></span><span class="arrow down"></span></button><button class="dropdown-link--mobile__title" type="button" aria-label="分类"><span class="title"><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->分类<!--]--></span></span></span><span class="right arrow"></span></button><ul style="display:none;" class="dropdown-link__container"><!--[--><li class="dropdown-link__item"><a href="/categories/backend/1.html" class="link" aria-label="backend"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->backend<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/categories/note/1.html" class="link" aria-label="note"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->note<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/categories/network/1.html" class="link" aria-label="network"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->network<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/categories/web/1.html" class="link" aria-label="web"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->web<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/categories/technology/1.html" class="link" aria-label="technology"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->technology<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/categories/arithmetic/1.html" class="link" aria-label="arithmetic"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->arithmetic<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/categories/interview/1.html" class="link" aria-label="interview"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->interview<!--]--></span></span><!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-links__item"><div class="dropdown-link"><button class="dropdown-link__title" type="button" aria-label="标签"><span class="xicon-container left title"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->标签<!--]--></span></span><span class="arrow down"></span></button><button class="dropdown-link--mobile__title" type="button" aria-label="标签"><span class="title"><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->标签<!--]--></span></span></span><span class="right arrow"></span></button><ul style="display:none;" class="dropdown-link__container"><!--[--><li class="dropdown-link__item"><a href="/tags/Golang/1.html" class="link" aria-label="Golang"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->Golang<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/gaobingfa/1.html" class="link" aria-label="高并发"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->高并发<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/AWS/1.html" class="link" aria-label="AWS"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->AWS<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/Github/1.html" class="link" aria-label="Github"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->Github<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/OAuth/1.html" class="link" aria-label="OAuth"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->OAuth<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/xiaolv/1.html" class="link" aria-label="效率"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->效率<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/wangluo/1.html" class="link" aria-label="网络"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->网络<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/peizhi/1.html" class="link" aria-label="配置"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->配置<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/houduan/1.html" class="link" aria-label="后端"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->后端<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/qukuailian/1.html" class="link" aria-label="区块链"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->区块链<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/Git/1.html" class="link" aria-label="Git"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->Git<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/Vue/1.html" class="link" aria-label="Vue"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->Vue<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/Webpack/1.html" class="link" aria-label="Webpack"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->Webpack<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/Vite/1.html" class="link" aria-label="Vite"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->Vite<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/gongju/1.html" class="link" aria-label="工具"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->工具<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/Linux/1.html" class="link" aria-label="Linux"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->Linux<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/kaifahuanjing/1.html" class="link" aria-label="开发环境"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->开发环境<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/MySQL/1.html" class="link" aria-label="MySQL"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->MySQL<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/mianshi/1.html" class="link" aria-label="面试"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->面试<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/qianduan/1.html" class="link" aria-label="前端"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->前端<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/suanfa/1.html" class="link" aria-label="算法"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->算法<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/JavaScript/1.html" class="link" aria-label="JavaScript"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->JavaScript<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/CentOS/1.html" class="link" aria-label="CentOS"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->CentOS<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/React/1.html" class="link" aria-label="React"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->React<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/ES6/1.html" class="link" aria-label="ES6"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->ES6<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/zhuanzai/1.html" class="link" aria-label="转载"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->转载<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/baocuo/1.html" class="link" aria-label="报错"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->报错<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/PHP/1.html" class="link" aria-label="PHP"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->PHP<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/sql/1.html" class="link" aria-label="sql"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->sql<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/gaoji/1.html" class="link" aria-label="搞机"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->搞机<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/luyouqi/1.html" class="link" aria-label="路由器"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->路由器<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/hexo/1.html" class="link" aria-label="hexo"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->hexo<!--]--></span></span><!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-links__item"><a class="link" href="https://github.com/12ain/blog" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->GitHub<!--]--></span></span><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><div class="appearance"><span>Appearance</span><span class="xicon-container btn-toggle-dark-mode"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" style="width:20px;height:20px;font-size:20px;color:inherit;"><path d="M15 2h2v3h-2z" fill="currentColor"></path><path d="M27 15h3v2h-3z" fill="currentColor"></path><path d="M15 27h2v3h-2z" fill="currentColor"></path><path d="M2 15h3v2H2z" fill="currentColor"></path><path d="M5.45 6.884l1.414-1.415l2.121 2.122l-1.414 1.414z" fill="currentColor"></path><path d="M23 7.58l2.121-2.12l1.414 1.414l-2.121 2.121z" fill="currentColor"></path><path d="M23.002 24.416l1.415-1.414l2.12 2.122l-1.413 1.414z" fill="currentColor"></path><path d="M5.47 25.13L7.59 23L9 24.42l-2.12 2.12l-1.41-1.41z" fill="currentColor"></path><path d="M16 8a8 8 0 1 0 8 8a8 8 0 0 0-8-8zm0 14a6 6 0 0 1 0-12z" fill="currentColor"></path></svg></span></div></div><div class="series-mask"></div><aside class="series-container"><div class="site-brand"><img class="logo" src="/logo.png" alt="Rain的心情杂货铺"><a href="/" class="site-name can-hide">Rain的心情杂货铺</a></div><!--[--><!--]--></aside><!--[--><main class="page-container"><h1 class="page-title">限流组件实现</h1><div class="page-info"><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:inherit;"><path d="M16 4a5 5 0 1 1-5 5a5 5 0 0 1 5-5m0-2a7 7 0 1 0 7 7a7 7 0 0 0-7-7z" fill="currentColor"></path><path d="M26 30h-2v-5a5 5 0 0 0-5-5h-6a5 5 0 0 0-5 5v5H6v-5a7 7 0 0 1 7-7h6a7 7 0 0 1 7 7z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->Rain<!--]--></span></span><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:inherit;"><path d="M26 4h-4V2h-2v2h-8V2h-2v2H6c-1.1 0-2 .9-2 2v20c0 1.1.9 2 2 2h20c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 22H6V12h20v14zm0-16H6V6h4v2h2V6h8v2h2V6h4v4z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->2024-02-07 23:01:07<!--]--></span></span><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:inherit;"><path d="M11.17 6l3.42 3.41l.58.59H28v16H4V6h7.17m0-2H4a2 2 0 0 0-2 2v20a2 2 0 0 0 2 2h24a2 2 0 0 0 2-2V10a2 2 0 0 0-2-2H16l-3.41-3.41A2 2 0 0 0 11.17 4z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[--><!--[--><a href="/categories/backend/1.html" class="">backend</a><!--]--><!--]--></span></span><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:inherit;"><path d="M10 14a4 4 0 1 1 4-4a4.005 4.005 0 0 1-4 4zm0-6a2 2 0 1 0 1.998 2.004A2.002 2.002 0 0 0 10 8z" fill="currentColor"></path><path d="M16.644 29.415L2.586 15.354A2 2 0 0 1 2 13.941V4a2 2 0 0 1 2-2h9.941a2 2 0 0 1 1.414.586l14.06 14.058a2 2 0 0 1 0 2.828l-9.943 9.943a2 2 0 0 1-2.829 0zM4 4v9.942L18.058 28L28 18.058L13.942 4z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[--><!--[--><a href="/tags/Golang/1.html" class="">Golang</a><a href="/tags/gaobingfa/1.html" class="">高并发</a><!--]--><!--]--></span></span><span class="xicon-container left"><!--[--><svg class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:inherit;" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 12 12"><g fill="none"><path d="M1.974 6.659a.5.5 0 0 1-.948-.317c-.01.03 0-.001 0-.001a1.633 1.633 0 0 1 .062-.162c.04-.095.099-.226.18-.381c.165-.31.422-.723.801-1.136C2.834 3.827 4.087 3 6 3c1.913 0 3.166.827 3.931 1.662a5.479 5.479 0 0 1 .98 1.517l.046.113c.003.008.013.06.023.11L11 6.5s.084.333-.342.474a.5.5 0 0 1-.632-.314v-.003l-.006-.016a3.678 3.678 0 0 0-.172-.376a4.477 4.477 0 0 0-.654-.927C8.584 4.673 7.587 4 6 4s-2.584.673-3.194 1.338a4.477 4.477 0 0 0-.795 1.225a2.209 2.209 0 0 0-.03.078l-.007.018zM6 5a2 2 0 1 0 0 4a2 2 0 0 0 0-4zM5 7a1 1 0 1 1 2 0a1 1 0 0 1-2 0z" fill="currentColor"></path></g></svg><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[--><span id="/blogs/backend/rateLimiter.html" class="leancloud-visitors" data-flag-title="Your Article Title"><a class="leancloud-visitors-count" style=""></a></span><!----><!--]--></span></span></div><div class="theme-reco-default-content"><div><h2 id="一、服务流量限制的重要性" tabindex="-1"><a class="header-anchor" href="#一、服务流量限制的重要性"><span><strong>一、服务流量限制的重要性</strong></span></a></h2><p>随着业务规模的增长,服务的流量也会激增,大流量可能会压垮服务器,导致服务瘫痪。因此需对服务的流量进行限制,确保在大流量的情况下也能正常运行。</p><p>当流量激增时,会占用大量服务器资源和带宽,可能会压垮整个系统。比如流量激增期间数据库连接用尽,会导致服务无法访问数据库而宕机。用限制流量可以有效防止流量暴增压垮系统。</p><p>没有限流时,流量激增期间会启动很多无用的任务占用服务器资源,造成不必要的浪费。适当限流可以排队或拒绝无效请求,有效控制资源消耗使用。</p><h2 id="二、常见的限流算法" tabindex="-1"><a class="header-anchor" href="#二、常见的限流算法"><span><strong>二、常见的限流算法</strong></span></a></h2><p>限流的基本思想是通过算法预先设置阈值,当流量达到阈值时自动限制,常见的限流算法有:</p><ol><li>计数器算法</li></ol><p>计数器算法根据时间窗口内的请求数进行限制,基本思路是设置一个计数器统计时间窗口内的请求数,当请求数达到限流阈值时,就拒绝服务或者排队。</p><p>**优点： **实现简单,资源消耗少。</p><p>**缺点： **无法处理突发流量,时间窗口比较难确定合适的值。</p><ol start="2"><li>漏桶算法</li></ol><p>漏桶算法是限制请求通过的速率,基本思路是设置桶的容量和流出速率,如果请求流入速率过大会被桶阻止,根据固定速率流出,起到平滑调节速率的作用。</p><p>**优点： **可以很好地应对突发流量。</p><p>**缺点： **需要实时处理每一个请求,对系统资源消耗较大。</p><ol start="3"><li>令牌桶算法</li></ol><p>令牌桶算法按照固定速率向桶中放入令牌,每次请求需要消耗一个令牌,只有拿到令牌的请求才允许通过。放令牌的速率可以通过调节,实现不同速率的请求限流。</p><p>**优点： **拥堵控制能力更强,可自定义速率。</p><p>**缺点： **需要实时处理请求,系统资源消耗依然比较大。</p><h2 id="三、限流实战" tabindex="-1"><a class="header-anchor" href="#三、限流实战"><span><strong>三、限流实战</strong></span></a></h2><ol><li>使用计数器限制总请求数</li></ol><p>计数器算法主要是基于时间窗口和计数器来进行限制的。下面来看一个基于计数器进行限流的实现:</p><div class="language-go line-numbers-mode" data-ext="go" data-title="go"><pre class="language-go"><code><span class="line"><span class="token keyword">package</span> limit</span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">(</span></span>
<span class="line">    <span class="token string">&quot;sync/atomic&quot;</span></span>
<span class="line">    <span class="token string">&quot;time&quot;</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 计数器限流器</span></span>
<span class="line"><span class="token keyword">type</span> CounterLimiter <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    count      <span class="token builtin">uint64</span> <span class="token comment">// 当前计数</span></span>
<span class="line">    lastUpdate <span class="token builtin">int64</span>  <span class="token comment">// 上次更新的时间</span></span>
<span class="line"></span>
<span class="line">    limitPerSec <span class="token builtin">uint64</span> <span class="token comment">// 每秒限制的请求数</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 创建计数器限流器</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">NewCounterLimiter</span><span class="token punctuation">(</span>limitPerSec <span class="token builtin">uint64</span><span class="token punctuation">)</span> <span class="token operator">*</span>CounterLimiter <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token operator">&amp;</span>CounterLimiter<span class="token punctuation">{</span></span>
<span class="line">        count<span class="token punctuation">:</span>      <span class="token number">0</span><span class="token punctuation">,</span></span>
<span class="line">        lastUpdate<span class="token punctuation">:</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Unix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        limitPerSec<span class="token punctuation">:</span> limitPerSec<span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 实现限流器接口的Allow()</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>CounterLimiter<span class="token punctuation">)</span> <span class="token function">Allow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span></span>
<span class="line">    now <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Unix</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    elapse <span class="token operator">:=</span> now <span class="token operator">-</span> c<span class="token punctuation">.</span>lastUpdate</span>
<span class="line"></span>
<span class="line">    c<span class="token punctuation">.</span>lastUpdate <span class="token operator">=</span> now</span>
<span class="line">    addedCount <span class="token operator">:=</span> elapse <span class="token operator">*</span> c<span class="token punctuation">.</span>limitPerSec</span>
<span class="line"></span>
<span class="line">    c<span class="token punctuation">.</span>count <span class="token operator">+=</span> <span class="token function">uint64</span><span class="token punctuation">(</span>addedCount<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> c<span class="token punctuation">.</span>count <span class="token operator">&gt;</span> c<span class="token punctuation">.</span>limitPerSec <span class="token punctuation">{</span></span>
<span class="line">        c<span class="token punctuation">.</span>count <span class="token operator">=</span> c<span class="token punctuation">.</span>limitPerSec</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">if</span> c<span class="token punctuation">.</span>count <span class="token operator">&lt;</span> c<span class="token punctuation">.</span>limitPerSec <span class="token punctuation">{</span></span>
<span class="line">        c<span class="token punctuation">.</span>count<span class="token operator">++</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">true</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">false</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>基于计数器的限流器 CounterLimiter，主要逻辑是</p><p>创建限流器时指定限流频率 limitPerSec</p><p>Allow() 方法校验是否限流</p><ul><li>计算当前时间和上次更新时间差 elapsed</li><li>根据时间差计算这段时间新增的限流额度 addedCount</li><li>计数器统计值增加 addedCount</li><li>判断计数器是否达到阈值</li><li>到达阈值则限流,未到则计数 +1 并放行</li></ul><p>只需要创建一个限流器,并在请求处理前调用 Allow() 方法判断是否限流即可。</p><div class="language-go line-numbers-mode" data-ext="go" data-title="go"><pre class="language-go"><code><span class="line"><span class="token keyword">func</span> <span class="token function">httpHandler</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">  limiter <span class="token operator">:=</span> <span class="token function">NewCounterLimiter</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">if</span> <span class="token operator">!</span>limiter<span class="token punctuation">.</span><span class="token function">Allow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    http<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> http<span class="token punctuation">.</span><span class="token function">StatusText</span><span class="token punctuation">(</span><span class="token number">429</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">      http<span class="token punctuation">.</span>StatusTooManyRequests<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">return</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// 核心逻辑</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>使用漏桶算法限制请求通过速率</li></ol><p>漏桶算法需要设置一个桶的容量 capacity,和漏出流量的速率 flow per second。如果请求流入速度过快,会被桶的容量限制而丢弃。</p><p>使用漏桶算法实现请求通过速率限流的示例:</p><div class="language-go line-numbers-mode" data-ext="go" data-title="go"><pre class="language-go"><code><span class="line"><span class="token keyword">type</span> LeakyBucket <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">  capacity     <span class="token builtin">int64</span> <span class="token comment">// 桶容量</span></span>
<span class="line">  used         <span class="token builtin">int64</span> <span class="token comment">// 当前已使用</span></span>
<span class="line">  mu           sync<span class="token punctuation">.</span>Mutex</span>
<span class="line">  lastLeakTime time<span class="token punctuation">.</span>Time <span class="token comment">// 上次漏水时间</span></span>
<span class="line"></span>
<span class="line">  flow <span class="token builtin">int64</span> <span class="token comment">// 每秒流速</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 创建漏桶限流器</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">NewLeakyBucket</span><span class="token punctuation">(</span>capacity<span class="token punctuation">,</span> flow <span class="token builtin">int64</span><span class="token punctuation">)</span> <span class="token operator">*</span>LeakyBucket <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token operator">&amp;</span>LeakyBucket<span class="token punctuation">{</span></span>
<span class="line">    capacity<span class="token punctuation">:</span> capacity<span class="token punctuation">,</span></span>
<span class="line">    used<span class="token punctuation">:</span>     <span class="token number">0</span><span class="token punctuation">,</span></span>
<span class="line">    flow<span class="token punctuation">:</span>     flow<span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 实现限流器接口的Allow()</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>l <span class="token operator">*</span>LeakyBucket<span class="token punctuation">)</span> <span class="token function">Allow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span></span>
<span class="line">  l<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token keyword">defer</span> l<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">  now <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">  l<span class="token punctuation">.</span><span class="token function">leak</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">if</span> l<span class="token punctuation">.</span>used <span class="token operator">&gt;=</span> l<span class="token punctuation">.</span>capacity <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">false</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  l<span class="token punctuation">.</span>used <span class="token operator">+=</span> <span class="token number">1</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token boolean">true</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 漏水处理</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>l <span class="token operator">*</span>LeakyBucket<span class="token punctuation">)</span> <span class="token function">leak</span><span class="token punctuation">(</span>now time<span class="token punctuation">.</span>Time<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">  delta <span class="token operator">:=</span> now<span class="token punctuation">.</span><span class="token function">Sub</span><span class="token punctuation">(</span>l<span class="token punctuation">.</span>lastLeakTime<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">  leaked <span class="token operator">:=</span> delta<span class="token punctuation">.</span><span class="token function">Seconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token function">float64</span><span class="token punctuation">(</span>l<span class="token punctuation">.</span>flow<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// 计算这段间隔内的漏水量</span></span>
<span class="line">  leakedInt <span class="token operator">:=</span> <span class="token function">int64</span><span class="token punctuation">(</span>leaked<span class="token punctuation">)</span></span>
<span class="line">  <span class="token keyword">if</span> leakedInt <span class="token operator">&gt;</span> <span class="token punctuation">(</span>l<span class="token punctuation">.</span>used<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 漏出了全部水</span></span>
<span class="line">    l<span class="token punctuation">.</span>used <span class="token operator">=</span> <span class="token number">0</span></span>
<span class="line">  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">    l<span class="token punctuation">.</span>used <span class="token operator">-=</span> leakedInt</span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  l<span class="token punctuation">.</span>lastLeakTime <span class="token operator">=</span> now</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>漏桶算法的实现主要分为两个部分:</p><ul><li>A llow() 方法检查当前使用量是否达到桶容量,未到则请求数 +1 并返回 true,已到则返回 false 限流</li><li>leak() 方法按照固定流速进行漏水,对应速率进行的限流</li></ul><p>可通过设置桶容量和流速,来限制请求通过系统的速率了。</p><ol start="3"><li>使用令牌桶算法释放固定数额的令牌</li></ol><p>令牌桶算法的主要逻辑是按照一定速率往桶中放入令牌。</p><p>请求在处理前需要先获取令牌,如果没有可用令牌则丢弃该请求或进入队列等待。</p><p>下面是使用令牌桶算法实现的限流器:</p><div class="language-go line-numbers-mode" data-ext="go" data-title="go"><pre class="language-go"><code><span class="line"><span class="token keyword">package</span> limit</span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">(</span></span>
<span class="line">  <span class="token string">&quot;sync&quot;</span></span>
<span class="line">  <span class="token string">&quot;time&quot;</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 令牌桶算法限流器</span></span>
<span class="line"><span class="token keyword">type</span> TokenBucket <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">  capacity   <span class="token builtin">int64</span> <span class="token comment">// 桶容量</span></span>
<span class="line">  rate       <span class="token builtin">int64</span> <span class="token comment">// 令牌放入速率</span></span>
<span class="line">  tokens     <span class="token builtin">int64</span> <span class="token comment">// 当前令牌数</span></span>
<span class="line">  lastUpdate <span class="token builtin">int64</span> <span class="token comment">// 上次添加令牌的时间</span></span>
<span class="line">  mu         sync<span class="token punctuation">.</span>Mutex</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 创建令牌桶限流器</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">NewTokenBucket</span><span class="token punctuation">(</span>capacity<span class="token punctuation">,</span> rate <span class="token builtin">int64</span><span class="token punctuation">)</span> <span class="token operator">*</span>TokenBucket <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token operator">&amp;</span>TokenBucket<span class="token punctuation">{</span>capacity<span class="token punctuation">:</span> capacity<span class="token punctuation">,</span> rate<span class="token punctuation">:</span> rate<span class="token punctuation">,</span> tokens<span class="token punctuation">:</span> capacity<span class="token punctuation">,</span> lastUpdate<span class="token punctuation">:</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Unix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// Allow 方法实现限流器接口</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>t <span class="token operator">*</span>TokenBucket<span class="token punctuation">)</span> <span class="token function">Allow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span></span>
<span class="line">  t<span class="token punctuation">.</span><span class="token function">addTokens</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">  t<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token keyword">defer</span> t<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token keyword">if</span> t<span class="token punctuation">.</span>tokens <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">false</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  t<span class="token punctuation">.</span>tokens<span class="token operator">--</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token boolean">true</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 按速率添加令牌</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>t <span class="token operator">*</span>TokenBucket<span class="token punctuation">)</span> <span class="token function">addTokens</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  now <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Unix</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">  elapse <span class="token operator">:=</span> now <span class="token operator">-</span> t<span class="token punctuation">.</span>lastUpdate</span>
<span class="line">  add <span class="token operator">:=</span> elapse <span class="token operator">*</span> t<span class="token punctuation">.</span>rate</span>
<span class="line">  t<span class="token punctuation">.</span>lastUpdate <span class="token operator">=</span> now</span>
<span class="line">  t<span class="token punctuation">.</span>tokens <span class="token operator">+=</span> add</span>
<span class="line">  <span class="token keyword">if</span> t<span class="token punctuation">.</span>tokens <span class="token operator">&gt;</span> t<span class="token punctuation">.</span>capacity <span class="token punctuation">{</span></span>
<span class="line">    t<span class="token punctuation">.</span>tokens <span class="token operator">=</span> t<span class="token punctuation">.</span>capacity</span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>主要逻辑分为两部分:</p><ul><li>Allow() 方法处理请求前获取令牌</li><li>addTokens() 方法按照速率往桶中添加令牌</li></ul><p>调整桶容量和添加令牌的速率,来达到平滑限流的效果。</p><ol start="4"><li>封装限流中间件,便于业务复用</li></ol><p>在上例中,实现了通用的限流器接口,包含创建限流器和 Allow() 校验方法。可以基于这个接口,进一步封装成限流中间件。</p><div class="language-go line-numbers-mode" data-ext="go" data-title="go"><pre class="language-go"><code><span class="line"><span class="token keyword">package</span> limit</span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token string">&quot;net/http&quot;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 中间件实现</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">LimitMiddleware</span><span class="token punctuation">(</span>handler http<span class="token punctuation">.</span>Handler<span class="token punctuation">,</span> limiter Limiter<span class="token punctuation">)</span> http<span class="token punctuation">.</span>Handler <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">return</span> http<span class="token punctuation">.</span><span class="token function">HandlerFunc</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span></span>
<span class="line">    r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">if</span> <span class="token operator">!</span>limiter<span class="token punctuation">.</span><span class="token function">Allow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">      http<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> http<span class="token punctuation">.</span><span class="token function">StatusText</span><span class="token punctuation">(</span><span class="token number">429</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        http<span class="token punctuation">.</span>StatusTooManyRequests<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">      <span class="token keyword">return</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    handler<span class="token punctuation">.</span><span class="token function">ServeHTTP</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> r<span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">// 使用方式</span></span>
<span class="line">  limiter <span class="token operator">:=</span> <span class="token function">NewTokenBucket</span><span class="token punctuation">(</span>capacity<span class="token punctuation">,</span> rate<span class="token punctuation">)</span></span>
<span class="line">  http<span class="token punctuation">.</span><span class="token function">Handle</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token function">LimitMiddleware</span><span class="token punctuation">(</span>myHandler<span class="token punctuation">,</span> limiter<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="四、优化限流策略" tabindex="-1"><a class="header-anchor" href="#四、优化限流策略"><span><strong>四、优化限流策略</strong></span></a></h2><p>很多时候业务访问量会有周期性波动或突发变化, 需要能够检测实时流量,动态调整限流参数。比如可以根据每分钟的请求量实时调整下一分钟的限流阈值。</p><p>根据业务需要可以设置自定义策略,比如对重要接口限流预留更多资源,对次要接口限流更严格等。允许更加细粒度地控制限流。</p><p>可以根据服务器负载、平均响应时间等指标,动态决定是否需要限流以保护系统。在流量大幅增长时自动跟进限制。</p><h2 id="五、使用-redis-实现分布式限流" tabindex="-1"><a class="header-anchor" href="#五、使用-redis-实现分布式限流"><span><strong>五、使用 Redis 实现分布式限流</strong></span></a></h2><p>之前的限流方式都是在单机上通过计数或时间实现,存在一定的不足。可使用 Redis 实现分布式限流。</p><p>Redis 的性能和扩展性优势：</p><p>Redis 单机可以达到 10 万 + QPS 的性能, pipeline 批量操作可以进一步提升这一指标。此外 Redis 很容易通过主从复制和分片来进行扩展。正是得益于这些优势,才使得它非常适合实现分布式限流。</p><p>利用 Redis 的计数器和定时任务实现分布式限制 ，主要的思想是:</p><ul><li>对每个唯一请求路径维护一个计数器</li><li>每次请求计数器 +1</li><li>当计数器达到阈值则返回限流</li><li>通过定时任务定期重置计数器计数</li></ul><p>客户端请求时通过 Lua 脚本 canRequest.lua 来进行判断:</p><div class="language-lua line-numbers-mode" data-ext="lua" data-title="lua"><pre class="language-lua"><code><span class="line"><span class="token comment">-- canRequest.lua 限流判断脚本</span></span>
<span class="line"><span class="token keyword">local</span> key <span class="token operator">=</span> KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span></span>
<span class="line"><span class="token keyword">local</span> limit <span class="token operator">=</span> <span class="token function">tonumber</span><span class="token punctuation">(</span>ARGV<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">local</span> current <span class="token operator">=</span> <span class="token function">tonumber</span><span class="token punctuation">(</span>redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">&#39;get&#39;</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">if</span> current <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&gt;</span> limit <span class="token keyword">then</span> </span>
<span class="line">    <span class="token keyword">return</span> <span class="token number">0</span></span>
<span class="line"><span class="token keyword">else</span></span>
<span class="line">    redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">&quot;INCRBY&quot;</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span></span>
<span class="line">    redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">&quot;expire&quot;</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> </span>
<span class="line">    <span class="token keyword">return</span> <span class="token number">1</span></span>
<span class="line"><span class="token keyword">end</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>使用一个唯一键 key 存储计数器,并设置 key 的过期时间,比如 1 秒。根据 key 的当前计数是否达到阈值来拒绝请求。可轻松通过 Redis 实现分布式限流,并可以横向扩展提高效率。</p></div></div><footer class="page-meta"><div class="meta-item edit-link"><span class="xicon-container left meta-item-label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" class="xicon-icon" style="width:20px;height:20px;font-size:20px;color:inherit;"><path d="M2 26h28v2H2z" fill="currentColor"></path><path d="M25.4 9c.8-.8.8-2 0-2.8l-3.6-3.6c-.8-.8-2-.8-2.8 0l-15 15V24h6.4l15-15zm-5-5L24 7.6l-3 3L17.4 7l3-3zM6 22v-3.6l10-10l3.6 3.6l-10 10H6z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->Edit this page<!--]--></span></span></div><div class="meta-item last-updated"><span class="xicon-container left meta-item-label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" class="xicon-icon" style="width:20px;height:20px;font-size:20px;color:inherit;"><path d="M26 4h-4V2h-2v2h-8V2h-2v2H6c-1.1 0-2 .9-2 2v20c0 1.1.9 2 2 2h20c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 22H6V12h20v14zm0-16H6V6h4v2h2V6h8v2h2V6h4v4z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->Last Updated 6/3/2024, 4:33:13 PM<!--]--></span></span></div></footer><!----><div class="reco-valine-wrapper"><div id="valine"></div></div></main><!--]--><div class="page-catalog-container"><h5 class="tip">ON THIS PAGE</h5><ul><!--[--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blogs/backend/rateLimiter.html#一、服务流量限制的重要性" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="一、服务流量限制的重要性"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->一、服务流量限制的重要性<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blogs/backend/rateLimiter.html#二、常见的限流算法" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="二、常见的限流算法"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->二、常见的限流算法<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blogs/backend/rateLimiter.html#三、限流实战" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="三、限流实战"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->三、限流实战<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blogs/backend/rateLimiter.html#四、优化限流策略" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="四、优化限流策略"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->四、优化限流策略<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blogs/backend/rateLimiter.html#五、使用-redis-实现分布式限流" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="五、使用 Redis 实现分布式限流"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->五、使用 Redis 实现分布式限流<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--></ul></div></div></div><!--[--><!----><!----><!--]--><!--]--></div>
    <script type="module" src="/assets/app-B6NiJo-f.js" defer></script>
  </body>
</html>
